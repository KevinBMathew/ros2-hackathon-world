<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gazebo SDF URI Path Replacer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-content {
            padding: 40px;
        }

        .input-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid #e9ecef;
        }

        .input-group {
            margin-bottom: 25px;
        }

        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .path-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .path-input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .file-status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .file-status.loading {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .file-status.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .file-status.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #27ae60, #229954);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.4);
        }

        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .output-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 30px;
            border: 2px solid #e9ecef;
        }

        .output-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3rem;
        }

        .preview-area {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            line-height: 1.4;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #e9ecef;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #3498db;
        }

        .stat-label {
            color: #7f8c8d;
            margin-top: 5px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîß Gazebo SDF URI Path Replacer</h1>
            <p>Automatically processes world.sdf and replaces model URIs with your custom path</p>
        </div>

        <div class="main-content">

            <div class="input-section">
                <div class="input-group">
                    <label>üóÇÔ∏è Choose SDF File</label>
                    <select id="sdfFileSelect" class="path-input" style="width: auto; max-width: 350px; display: inline-block;">
                        <option value="world.sdf">world.sdf</option>
                        <option value="warehouse_correct_locations.sdf">warehouse_correct_locations.sdf</option>
                    </select>
                </div>
                <div id="fileStatus" class="file-status loading">
                    üìÑ Loading world.sdf file...
                </div>

                <div class="input-group">
                    <label for="newPath">üóÇÔ∏è New Models Directory Path</label>
                    <input 
                        type="text" 
                        id="newPath" 
                        class="path-input" 
                        placeholder="e.g., /home/myuser/gazebo_models or file:///path/to/models"
                        value=""
                    />
                    <small style="color: #7f8c8d; margin-top: 5px; display: block;">
                        Enter the new path to your models directory.
                    </small>
                </div>
            <div class="input-group">
                <label>üì¶ Download All Models</label>
                <a href="./models.zip" class="btn btn-primary" download style="margin-top: 8px;">
                    ‚¨áÔ∏è Download models.zip
                </a>
                <small style="color: #7f8c8d; margin-top: 5px; display: block;">
                    Download a zip archive of all models referenced in the SDF file.
                </small>
            </div>

            <div class="input-group">
                <label>üì¶ Download Forklift</label>
                <a href="./forklift.zip" class="btn btn-primary" download style="margin-top: 8px;">
                    ‚¨áÔ∏è Download forklift.zip
                </a>
                <small style="color: #7f8c8d; margin-top: 5px; display: block;">
                    Download a zip archive of the forklift-like robot that you can modify and use.
                </small>
            </div>

            <div class="input-group">
                <label>üêß Linux .bashrc Command</label>
                <div style="position: relative;">
                    <input type="text" id="bashrcCommand" class="path-input" readonly value="" style="font-family: monospace; background: #f4f4f4; cursor: pointer;" onclick="this.select(); document.execCommand('copy');">
                    <button id="copyBashrcBtn" class="btn btn-primary" style="position: absolute; right: 5px; top: 5px; padding: 6px 12px; font-size: 0.9rem;">Copy</button>
                </div>
                <small style="color: #7f8c8d; margin-top: 5px; display: block;">
                    Copy and run this command in your Linux terminal to add the models path to your <code>.bashrc</code>.
                </small>
            </div>

                <div class="button-group">
                    <button id="processBtn" class="btn btn-primary" disabled>
                        üîÑ Process File
                    </button>
                    <button id="downloadBtn" class="btn btn-success" disabled>
                        üíæ Download Modified SDF
                    </button>
                </div>
            </div>

            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Processing your SDF file...</p>
            </div>

            <div class="output-section" id="outputSection" style="display: none;">
                <h3>üìä Processing Results</h3>
                
                <div class="stats" id="stats"></div>

                <div class="alert alert-info" id="resultAlert"></div>

                <h3>üìÑ Modified Content Preview</h3>
                <div class="preview-area" id="preview"></div>
            </div>
        </div>
    </div>

    <script>

        class SDFProcessor {
            constructor() {
                this.originalContent = '';
                this.modifiedContent = '';
                this.replacementCount = 0;
                this.selectedFile = 'world.sdf';
                this.fileCache = {};
                this.initializeEventListeners();
                this.loadSelectedFile();
            }


            initializeEventListeners() {
                document.getElementById('processBtn').addEventListener('click', this.processFile.bind(this));
                document.getElementById('downloadBtn').addEventListener('click', this.downloadFile.bind(this));

                // File select dropdown
                document.getElementById('sdfFileSelect').addEventListener('change', (e) => {
                    this.selectedFile = e.target.value;
                    this.loadSelectedFile();
                });

                // Allow processing when Enter is pressed in the path input
                document.getElementById('newPath').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.processFile();
                    }
                });

                // Update button state when path changes
                document.getElementById('newPath').addEventListener('input', this.updateProcessButton.bind(this));

                // Update bashrc command when path changes
                document.getElementById('newPath').addEventListener('input', this.updateBashrcCommand.bind(this));
                // Also update on page load
                this.updateBashrcCommand();

                // Copy button
                document.getElementById('copyBashrcBtn').addEventListener('click', () => {
                    const input = document.getElementById('bashrcCommand');
                    input.select();
                    document.execCommand('copy');
                    document.getElementById('copyBashrcBtn').textContent = 'Copied!';
                    setTimeout(() => {
                        document.getElementById('copyBashrcBtn').textContent = 'Copy';
                    }, 1200);
                });
            }

                updateBashrcCommand() {
                    const newPath = document.getElementById('newPath').value.trim();
                    let bashPath = newPath;
                    if (!bashPath) {
                        document.getElementById('bashrcCommand').value = '';
                        document.getElementById('copyBashrcBtn').disabled = true;
                        return;
                    }
                    // Remove file:// prefix if present
                    if (bashPath.startsWith('file://')) {
                        bashPath = bashPath.replace(/^file:\/\//, '');
                    }
                    // Remove trailing slash
                    if (bashPath.endsWith('/')) {
                        bashPath = bashPath.slice(0, -1);
                    }
                    // Compose the command
                    const cmd = `echo 'export IGN_GAZEBO_RESOURCE_PATH="${bashPath}:$IGN_GAZEBO_RESOURCE_PATH"' >> ~/.bashrc`;
                    document.getElementById('bashrcCommand').value = cmd;
                    document.getElementById('copyBashrcBtn').disabled = false;
                }


            async loadSelectedFile() {
                const fileStatus = document.getElementById('fileStatus');
                const fileName = this.selectedFile;
                fileStatus.textContent = `üìÑ Loading ${fileName} file...`;
                fileStatus.className = 'file-status loading';

                // Use cache if already loaded
                if (this.fileCache[fileName]) {
                    this.originalContent = this.fileCache[fileName];
                    fileStatus.textContent = `‚úÖ ${fileName} loaded successfully!`;
                    fileStatus.className = 'file-status success';
                    this.updateProcessButton();
                    return;
                }

                try {
                    const response = await fetch(`./${fileName}`);
                    if (!response.ok) {
                        throw new Error(`Failed to load ${fileName}: ${response.status} ${response.statusText}`);
                    }
                    this.originalContent = await response.text();
                    this.fileCache[fileName] = this.originalContent;
                    fileStatus.textContent = `‚úÖ ${fileName} loaded successfully!`;
                    fileStatus.className = 'file-status success';
                    this.updateProcessButton();
                } catch (error) {
                    console.error(`Error loading ${fileName}:`, error);
                    fileStatus.textContent = `‚ùå Error loading ${fileName}: ${error.message}`;
                    fileStatus.className = 'file-status error';
                }
            }

            updateProcessButton() {
                const hasFile = this.originalContent.length > 0;
                const hasPath = document.getElementById('newPath').value.trim().length > 0;
                document.getElementById('processBtn').disabled = !(hasFile && hasPath);
            }

            processFile() {
                const newPath = document.getElementById('newPath').value.trim();
                
                if (!this.originalContent) {
                    alert('World.sdf file is not loaded yet.');
                    return;
                }

                if (!newPath) {
                    alert('Please enter a new models directory path.');
                    return;
                }

                this.showLoading(true);

                // Simulate processing delay for better UX
                setTimeout(() => {
                    this.performReplacement(newPath);
                    this.showLoading(false);
                    this.displayResults();
                }, 500);
            }

            performReplacement(newPath) {
                // Ensure the new path ends with proper formatting
                let formattedPath = newPath;
                
                // Add file:// prefix if not present
                if (!formattedPath.startsWith('file://')) {
                    formattedPath = 'file://' + (formattedPath.startsWith('/') ? '' : '/') + formattedPath;
                }
                
                // Ensure path ends with / for proper concatenation
                if (!formattedPath.endsWith('/')) {
                    formattedPath += '/';
                }

                // Replace all instances of the original path
                const originalPattern = /file:\/\/\/home\/kevin\/models\//g;
                
                // Count matches before replacement
                const matches = this.originalContent.match(originalPattern);
                this.replacementCount = matches ? matches.length : 0;
                
                // Perform replacement
                this.modifiedContent = this.originalContent.replace(originalPattern, formattedPath);
            }

            showLoading(show) {
                document.getElementById('loading').style.display = show ? 'block' : 'none';
                document.getElementById('outputSection').style.display = show ? 'none' : 'block';
            }

            displayResults() {
                // Update stats
                this.updateStats();
                
                // Update result alert
                const alertDiv = document.getElementById('resultAlert');
                if (this.replacementCount > 0) {
                    alertDiv.innerHTML = `
                        <strong>‚úÖ Success!</strong> 
                        Found and replaced ${this.replacementCount} URI path${this.replacementCount !== 1 ? 's' : ''} 
                        in your SDF file.
                    `;
                    alertDiv.className = 'alert alert-info';
                } else {
                    alertDiv.innerHTML = `
                        <strong>‚ö†Ô∏è No matches found!</strong> 
                        The file doesn't contain any paths matching "file:///home/kevin/models/".
                        Please verify this is the correct SDF file.
                    `;
                    alertDiv.className = 'alert alert-warning';
                }

                // Update preview
                const preview = document.getElementById('preview');
                const previewContent = this.modifiedContent.substring(0, 2000);
                preview.textContent = previewContent + (this.modifiedContent.length > 2000 ? '\n\n... (truncated)' : '');

                // Enable download button
                document.getElementById('downloadBtn').disabled = this.replacementCount === 0;
                
                // Show results section
                document.getElementById('outputSection').style.display = 'block';
            }

            updateStats() {
                const stats = [
                    { label: 'URIs Replaced', value: this.replacementCount },
                    { label: 'File Size (KB)', value: Math.round(this.modifiedContent.length / 1024) },
                    { label: 'Total Lines', value: this.modifiedContent.split('\n').length },
                    { label: 'Total Models', value: this.countUniqueModels() }
                ];

                const statsHTML = stats.map(stat => `
                    <div class="stat-card">
                        <div class="stat-number">${stat.value}</div>
                        <div class="stat-label">${stat.label}</div>
                    </div>
                `).join('');

                document.getElementById('stats').innerHTML = statsHTML;
            }

            countUniqueModels() {
                // Count unique model references
                const modelMatches = this.modifiedContent.match(/file:\/\/[^"'>]+\/([^\/]+)\/model:/g);
                if (!modelMatches) return 0;
                
                const uniqueModels = new Set();
                modelMatches.forEach(match => {
                    const modelName = match.match(/\/([^\/]+)\/model:/)[1];
                    uniqueModels.add(modelName);
                });
                
                return uniqueModels.size;
            }

            downloadFile() {
                if (!this.modifiedContent) {
                    alert('No modified content to download.');
                    return;
                }
                // Use the selected file name for download, with _modified
                let base = this.selectedFile.replace(/\.sdf$/, '');
                const blob = new Blob([this.modifiedContent], { type: 'application/xml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${base}_modified.sdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }
        }

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new SDFProcessor();
        });
    </script>
</body>
</html>
